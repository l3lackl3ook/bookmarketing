{% extends 'base2.html' %}
{% load static %}
{% load humanize %}
{% block content %}
  <!-- Minimal modern design variables and component styles (imported from group_detail.html) -->
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #64748b;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --border-radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Montserrat', 'Prompt', sans-serif;
      background-color: var(--gray-50);
      color: var(--gray-800);
      line-height: 1.6;
    }

    /* Card Improvements */
    .card {
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      background: white;
      transition: all 0.2s ease;
    }
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    .card-header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 1.25rem 1.5rem;
      font-weight: 600;
      color: var(--gray-800);
    }

    /* Button Improvements */
    .btn-primary-custom {
      background: linear-gradient(135deg, var(--primary-color) 0%, #3b82f6 100%);
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-primary-custom:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, #1d4ed8 0%, var(--primary-color) 100%);
    }
    .btn-orange {
      background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .btn-orange:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%);
    }

    /* Outline style buttons used for export/presentation controls */
    .btn-outline-orange {
      border: 1px solid #FF6B00;
      color: #FF6B00;
      background-color: transparent;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.875rem;
    }
    .btn-outline-orange:hover {
      background-color: #FF6B00;
      color: white;
      box-shadow: var(--shadow-md);
    }
    .btn-outline-orange:focus {
      box-shadow: 0 0 0 2px rgba(255, 107, 0, 0.3);
    }

    /* Table Improvements */
    .table {
      margin-bottom: 0;
    }
    .table th {
      border-top: none;
      border-bottom: 2px solid var(--gray-200);
      font-weight: 600;
      color: var(--gray-700);
      padding: 1rem 0.75rem;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .table td {
      padding: 1rem 0.75rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
    }
    .table tbody tr:hover {
      background-color: var(--gray-50);
    }

    /* Modal Improvements */
    .modal-content {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      border-bottom: 1px solid var(--gray-200);
      padding: 1.5rem;
    }
    .modal-body {
      padding: 1.5rem;
    }
    .modal-fullscreen .modal-content {
      border-radius: 0;
    }

    /* Close Button Improvements */
    .btn-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray-500);
      cursor: pointer;
      z-index: 1051;
      transition: all 0.2s ease;
    }
    .btn-close:hover {
      color: var(--gray-800);
      transform: scale(1.1);
    }

    /* Chart Container Improvements */
    .chart-container {
      position: relative;
      height: 350px;
    }

    /* Profile Image Improvements */
    .profile-img {
      border: 2px solid white;
      box-shadow: var(--shadow-sm);
    }

    /* Platform Icon Improvements */
    .platform-icon {
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Hover Effects */
    .hover-count {
      position: relative;
      cursor: pointer;
    }
    .hover-count .full {
      display: none;
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--gray-800);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
    }
  </style>
<!-- Content wrapper -->
<div class="content-wrapper">
  <div class="container-xxl flex-grow-1 container-p-y">
    <div id="pageInfoCard" class="card p-4 mb-4">
      <div class="row justify-content-between align-items-start mb-4">
        <div class="col-md-9 d-flex">
          <div class="position-relative me-3">
            <a href="{{ page.page_url }}" target="_blank" class="position-absolute" style="top: 0px; left: 90px; z-index: 2;">
              {% if page.platform == "facebook" %}
                <img src="{% static 'assets/img/icons/facebook-icon.webp' %}" alt="Facebook Icon" style="width: 20px; height: 20px;" />
              {% elif page.platform == "tiktok" %}
                <img src="{% static 'assets/img/icons/tiktoklogo.webp' %}" alt="TikTok Icon" style="width: 20px; height: 20px;" />
              {% elif page.platform == "instagram" %}
                <img src="{% static 'assets/img/icons/iglogo.png' %}" alt="Instagram Icon" style="width: 35px; height: 28px;" />
              {% elif page.platform == "lemon8" %}
                <img src="{% static 'assets/img/icons/lemon8logo.png' %}" alt="Lemon8 Icon" style="width: 25px; height: 25 px;" />
              {% elif page.platform == "youtube" %}
                <img src="{% static 'assets/img/icons/youtubelogo.png' %}" alt="Youtube Icon" style="width: 25px; height: 25 px;" />
              {% endif %}
            </a>
            <a href="{{ page.page_url }}" target="_blank">
              <img class="rounded-circle border border-2 border-light" src="{{ page.profile_pic|default:'/static/assets/default-profile.png' }}" alt="Page Logo" width="100" height="100" />
            </a>
          </div>
      <div class="ms-2">
    <h5 class="mb-2">{{ page.page_name|default:page.page_username }}</h5>
    <div class="text-muted mb-1">
        <strong>Page Username:</strong>
        {% if page.platform == "lemon8" %}
            {% with page.page_url|cut:"https://www.lemon8-app.com/" as lemon8_user %}
                {{ lemon8_user }}
            {% endwith %}
        {% elif page.platform == "youtube" %}
            {% with page.page_url|cut:"http://www.youtube.com/"|cut:"https://www.youtube.com/"|cut:"@" as yt_user %}
                {{ yt_user }}
            {% endwith %}
        {% else %}
            {{ page.page_username|default:"-" }}
        {% endif %}
    </div>
            {% if page.platform == "facebook" %}
              <div class="text-muted mb-1"><strong>Page Categories:</strong> {{ page.page_category|default:"-" }}</div>
            {% elif page.platform == "instagram" %}
              <div class="text-muted mb-1"><strong>Platform:</strong> Instagram</div>
            {% elif page.platform == "lemon8" %}
              <div class="text-muted mb-1"><strong>Platform:</strong> Lemon8</div>
                {% elif page.platform == "youtube" %}
              <div class="text-muted mb-1"><strong>Platform:</strong> YouTube</div>
            {% endif %}
          </div>
        </div>
        <div class="col-auto ms-auto d-flex align-items-center gap-2">
          <!-- Export buttons for page info -->
          <button class="btn btn-orange" style="padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 6px;" onclick="exportPageInfoPDF()">Export to PDF</button>
          <button class="btn btn-orange" style="padding: 0.5rem 1rem; font-size: 0.875rem; border-radius: 6px;" onclick="exportPageInfoCSV()">Export to CSV</button>
        </div>
      </div>

      {% if page.platform == "facebook" %}
      <div class="row mb-4">
        <div class="col-md-4 text-muted"><strong>Page Website:</strong> <a href="{{ page.page_website }}">{{ page.page_website|default:"-" }}</a></div>
        <div class="col-md-4 text-muted"><strong>Page Email:</strong> <a href="mailto:{{ page.page_email }}">{{ page.page_email|default:"-" }}</a></div>
        <div class="col-md-4 text-muted"><strong>Page Number:</strong> {{ page.page_phone|default:"-" }}</div>
      </div>
      {% elif page.platform == "tiktok" %}
      <div class="row mb-4">
        <div class="col-md-4 text-muted"><strong>Platform:</strong> TikTok</div>
        <div class="col-md-4 text-muted"><strong>Contact:</strong> -</div>
        <div class="col-md-4 text-muted"><strong>Phone:</strong> -</div>
      </div>
      {% elif page.platform == "instagram" %}
      <div class="row mb-4">
        <div class="col-md-4 text-muted"><strong>Website:</strong> <a href="{{ page.page_website }}">{{ page.page_website|default:"-" }}</a></div>
        <div class="col-md-4 text-muted"><strong>Category:</strong> {{ page.page_category|default:"-" }}</div>
      </div>
      {% elif page.platform == "lemon8" %}
      <div class="row mb-4">
        <div class="col-md-4 text-muted"><strong>Website:</strong> <a href="{{ page.page_website }}">{{ page.page_website|default:"-" }}</a></div>
        <div class="col-md-4 text-muted"><strong>Age:</strong> {{ page.age|default:"-" }}</div>
        <div class="col-md-4 text-muted"><strong>Following:</strong> {{ page.following_count|intcomma|default:"-" }}</div>
      </div>
      {% elif page.platform == "youtube" %}
  <div class="row mb-4">
        <div class="col-md-4 text-muted"><strong>Website:</strong> <a href="{{ page.page_website }}">{{ page.page_website|default:"-" }}</a></div>
    <div class="col-md-4 text-muted"><strong>Country:</strong> {{ page.page_address|default:"-" }}</div>
    <div class="col-md-4 text-muted"><strong>Join Date:</strong> {{ page.page_join_date|default:"-" }}</div>
  </div>
      {% endif %}

<div class="row mb-4 mt-3">
  <div class="col-md-8">
    <strong>
      {% if page.platform == "facebook" %}Page Description:{% elif page.platform == "instagram" %}Bio:{% elif page.platform == "lemon8" %}Bio:{% else %}Description:{% endif %}
    </strong>
    <div class="text-muted">{{ page.page_description|default:"-" }}</div>
  </div>

  {# ✅ เงื่อนไขแสดง Page Address เฉพาะ Facebook ถ้ามี #}
  {% if page.platform == "facebook" and page.page_address %}
    <div class="col-md-4">
      <strong>Page Address:</strong>
      <div class="text-muted">{{ page.page_address }}</div>
    </div>
  {% endif %}
</div>

<hr class="my-4" />

      <div class="row text-center mt-4">
        <div class="col">
          <div class="fw-semibold">
            {% if page.platform == "facebook" %}
              {{ page.page_followers_count|intcomma|default:"-" }}
            {% elif page.platform == "tiktok" %}
              {{ page.page_followers|intcomma|default:"-" }}
            {% elif page.platform == "instagram" or page.platform == "lemon8" %}
              {{ page.page_followers|intcomma|default:"-" }}
                {% elif page.platform == "youtube" %}
              {{ page.page_followers|intcomma|default:"-" }}
            {% endif %}
          </div>
          <div class="text-muted small">
      {% if page.platform == "youtube" %}
        Subscribe
      {% else %}
        Followers
      {% endif %}
    </div>
        </div>
        <div class="col">
          <div class="fw-semibold">
            {% if page.platform == "facebook" %}
              {{ page.page_likes_count|intcomma|default:"-" }}
            {% elif page.platform == "tiktok" %}
              {{ page.page_likes|intcomma|default:"-" }}
            {% elif page.platform == "instagram" %}
              {{ page.post_count|intcomma|default:"-" }}
            {% elif page.platform == "lemon8" %}
              {{ page.page_likes|intcomma|default:"-" }}
                {% elif page.platform == "youtube" %}
  {{ page.page_total_views|intcomma|default:"-" }}
            {% else %}
              -
            {% endif %}
          </div>
          <div class="text-muted small">
  {% if page.platform == "youtube" %}All Views{% elif page.platform == "instagram" %}All Post{% elif page.platform == "lemon8" %}Likes{% else %}Likes{% endif %}
          </div>
        </div>
        <div class="col">
          <div class="fw-semibold">
            {% if page.platform == "facebook" %}
              {{ page.page_talking_count|intcomma|default:"-" }}
            {% elif page.platform == "youtube" or page.platform == "tiktok" %}
              {{ page.page_videos_count|intcomma|default:"-" }}
            {% endif %}
          </div>
          <div class="text-muted small">
            {% if page.platform == "facebook" %}
              Talking
            {% elif page.platform == "youtube" or page.platform == "tiktok" %}
              All Videos
            {% endif %}
          </div>
        </div>




  </div>
</div>

  {% if facebook_posts or facebook_posts_flop %}
<div class="row">

  <!-- 🔥 Top Posts by Engagement -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm border-0" id="topPostsCard">
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Top 10 Posts by Engagement</h5>
          <!-- Removed presentation/export controls for Top Posts by request -->
        </div>
        <div style="max-height: 600px; overflow-y: auto;">
          {% for post in facebook_posts_top10 %}
          <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
            <div style="width: 90px; height: 90px; flex-shrink: 0; position: relative; overflow: hidden;">
            {% if post.post_imgs %}
            <a href="https://www.facebook.com/{{ post.post_id }}" target="_blank">
              <img src="{{ post.post_imgs.0 }}" style="height: 100%; width: 90px; object-fit: cover;" class="rounded-start" />
            </a>
            {% else %}
             <div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>
            {% endif %}
            </div>
            <div class="flex-grow-1 px-2 py-1 d-flex flex-column justify-content-between" style="min-width: 0;">
              <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex align-items-center gap-2">
                  <!-- Container ปรับขนาดใหม่ให้พอดีกับขนาดภาพ -->
<div class="position-relative d-inline-block" style="width: 24px; height: 24px;">
  <!-- รูปเพจ -->
  <img src="{{ page.profile_pic }}" class="rounded-circle border border-white"
       width="24" height="24" style="object-fit: cover;">

  <!-- ไอคอน Facebook -->
  <img src="{% static 'assets/img/icons/facebooklogo.png' %}"
       width="10" height="10"
       class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
</div>
                  <strong class="text-truncate">{{ page.page_name }}</strong>
                </div>
                <div class="text-muted small" style="font-size: 0.65rem;">{{ post.post_timestamp_dt|date:"j M Y - H:i" }}</div>
              </div>
              <div class="mt-1 text-dark" style="display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;">
                {{ post.post_content }}
              </div>
              <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                {% if post.reactions %}
                  {% for reaction, count in post.reactions.items %}
                    {% if reaction == "ถูกใจ" %}<span>👍 {{ count }}</span>{% endif %}
                    {% if reaction == "ห่วงใย" %}<span>🥰 {{ count }}</span>{% endif %}
                    {% if reaction == "รักเลย" %}<span>❤️ {{ count }}</span>{% endif %}
                    {% if reaction == "เศร้า" %}<span>😢 {{ count }}</span>{% endif %}
                    {% if reaction == "โกรธ" %}<span>😡 {{ count }}</span>{% endif %}
                    {% if reaction == "ว้าว" %}<span>😮 {{ count }}</span>{% endif %}
                    {% if reaction == "ฮ่าๆ" or reaction == "ฮา" %}<span>😂 {{ count }}</span>{% endif %}
                  {% endfor %}
                {% endif %}
                <span>💬 {{ post.comment_count|default:0 }}</span>
                <span>↪ {{ post.share_count|default:0 }}</span>
                <span class="ms-auto fw-semibold text-dark">🔥 {{ post.total_engagement }}</span>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- 🧊 Flop 10 Facebook Posts -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm border-0">
      <div class="card-body p-3">
        <h5 class="card-title mb-3">Flop 10 Posts by Engagement</h5>
        <div style="max-height: 600px; overflow-y: auto;">
          {% for post in facebook_posts_flop %}
          <div class="d-flex border rounded mb-2 small overflow-hidden">
            <div style="width: 90px; height: 90px; flex-shrink: 0; position: relative; overflow: hidden;">
            {% if post.post_imgs %}
            <a href="https://www.facebook.com/{{ post.post_id }}" target="_blank">
              <img src="{{ post.post_imgs.0 }}" style="height: 100%; width: 90px; object-fit: cover;" class="rounded-start" />
            </a>
            {% else %}
             <div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>
            {% endif %}
            </div>
            <div class="flex-grow-1 d-flex flex-column justify-content-between px-3 py-2" style="min-width: 0; overflow: hidden;">
              <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex align-items-center gap-2">
                                    <!-- Container ปรับขนาดใหม่ให้พอดีกับขนาดภาพ -->
<div class="position-relative d-inline-block" style="width: 24px; height: 24px;">
  <!-- รูปเพจ -->
  <img src="{{ page.profile_pic }}" class="rounded-circle border border-white"
       width="24" height="24" style="object-fit: cover;">

  <!-- ไอคอน Facebook -->
  <img src="{% static 'assets/img/icons/facebooklogo.png' %}"
       width="10" height="10"
       class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
</div>
                  <strong class="text-truncate">{{ page.page_name }}</strong>
                </div>
                <div class="text-muted small" style="font-size: 0.65rem;">{{ post.post_timestamp_dt|date:"j M Y - H:i" }}</div>
              </div>
              <div class="mt-1 text-dark" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;">
                {{ post.post_content }}
              </div>
              <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                {% if post.reactions %}
                  {% for reaction, count in post.reactions.items %}
                    {% if reaction == "ถูกใจ" %}<span>👍 {{ count }}</span>{% endif %}
                    {% if reaction == "ห่วงใย" %}<span>🥰 {{ count }}</span>{% endif %}
                    {% if reaction == "รักเลย" %}<span>❤️ {{ count }}</span>{% endif %}
                    {% if reaction == "เศร้า" %}<span>😢 {{ count }}</span>{% endif %}
                    {% if reaction == "โกรธ" %}<span>😡 {{ count }}</span>{% endif %}
                    {% if reaction == "ว้าว" %}<span>😮 {{ count }}</span>{% endif %}
                    {% if reaction == "ขำ" or reaction == "ฮ่าๆ" %}<span>😂 {{ count }}</span>{% endif %}
                  {% endfor %}
                {% endif %}
                <span>💬 {{ post.comment_count|default:0 }}</span>
                <span>↪ {{ post.share_count|default:0 }}</span>
                <span class="ms-auto fw-semibold text-dark">🔥 {{ post.total_engagement }}</span>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

</div>

{% endif %}

  {# ====================== TikTok Posts Section ====================== #}
  {% if page.platform == "tiktok" %}
  <div class="row">
    <!-- 🔥 Top 10 TikTok Posts -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm border-0">
        <div class="card-body p-3">
          <h5 class="card-title mb-3">Top 10 TikTok Posts</h5>
          <div style="max-height: 600px; overflow-y: auto;">
            {% for post in tiktok_posts_top10 %}
            <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
              <div style="width: 90px; height: 90px; flex-shrink: 0; position: relative; overflow: hidden;">
                {% if post.post_imgs %}
                <a href="{{ post.post_url }}" target="_blank">
                  <img src="{{ post.post_imgs.0 }}" style="height: 100%; width: 90px; object-fit: cover;" class="rounded-start" />
                </a>
                {% else %}
                 <div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>
                {% endif %}
              </div>
              <div class="flex-grow-1 px-2 py-1 d-flex flex-column justify-content-between" style="min-width: 0;">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="d-flex align-items-center gap-2">
                    <div class="position-relative d-inline-block" style="width: 24px; height: 24px;">
                      <img src="{{ post.profile_pic|default:page.profile_pic }}" class="rounded-circle border border-white" width="24" height="24" style="object-fit: cover;">
                      <img src="{% static 'assets/img/icons/tiktoklogo.webp' %}" width="10" height="10" class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
                    </div>
                    <strong class="text-truncate">{{ post.page_name }}</strong>
                  </div>
                  <div class="text-muted small" style="font-size: 0.65rem;">{{ post.post_timestamp|default:'' }}</div>
                </div>
                <div class="mt-1 text-dark" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;">
                  {{ post.post_content|default:'' }}
                </div>
                <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                  <span>❤️ {{ post.like_count|default:0 }}</span>
                  <span>💬 {{ post.comment_count|default:0 }}</span>
                  <span>↪ {{ post.share_count|default:0 }}</span>
                  <span>🔖 {{ post.save_count|default:0 }}</span>
                  <span class="ms-auto fw-semibold text-dark">👁 {{ post.view_count|default:0 }}</span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- 🧊 Flop 10 TikTok Posts -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm border-0">
        <div class="card-body p-3">
          <h5 class="card-title mb-3">Flop 10 TikTok Posts</h5>
          <div style="max-height: 600px; overflow-y: auto;">
            {% for post in tiktok_posts_flop %}
            <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
              <div style="width: 90px; height: 90px; flex-shrink: 0; position: relative; overflow: hidden;">
                {% if post.post_imgs %}
                <a href="{{ post.post_url }}" target="_blank">
                  <img src="{{ post.post_imgs.0 }}" style="height: 100%; width: 90px; object-fit: cover;" class="rounded-start" />
                </a>
                {% else %}
                 <div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>
                {% endif %}
              </div>
              <div class="flex-grow-1 d-flex flex-column justify-content-between px-3 py-2" style="min-width: 0; overflow: hidden;">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="d-flex align-items-center gap-2">
                    <div class="position-relative d-inline-block" style="width: 24px; height: 24px;">
                      <img src="{{ post.profile_pic|default:page.profile_pic }}" class="rounded-circle border border-white" width="24" height="24" style="object-fit: cover;">
                      <img src="{% static 'assets/img/icons/tiktoklogo.webp' %}" width="10" height="10" class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
                    </div>
                    <strong class="text-truncate">{{ post.page_name }}</strong>
                  </div>
                  <div class="text-muted small" style="font-size: 0.65rem;">{{ post.post_timestamp|default:'' }}</div>
                </div>
                <div class="mt-1 text-dark" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;">
                  {{ post.post_content|default:'' }}
                </div>
                <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                  <span>❤️ {{ post.like_count|default:0 }}</span>
                  <span>💬 {{ post.comment_count|default:0 }}</span>
                  <span>↪ {{ post.share_count|default:0 }}</span>
                  <span>🔖 {{ post.save_count|default:0 }}</span>
                  <span class="ms-auto fw-semibold text-dark">👁 {{ post.view_count|default:0 }}</span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  <!-- 📊 New 100 Posts Overview -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body p-3">
    <h5 class="card-title mb-3">New 100 Posts Overview</h5>
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
      <table class="table table-sm table-hover align-middle mb-0 small">
        <thead class="table-light text-center align-middle" style="line-height: 1.0; position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
          <tr>
            <th style="width: 40px;">
              <span class="visually-hidden">#</span>
            </th>
            <th style="min-width: 180px;">
                <span class="visually-hidden">Page</span>
            </th>
            <th style="min-width: 250px;">Post</th>
            <!-- ลบคอลัมน์ Date ออก -->
            <th>Likes</th>
            <th>Comments</th>
            <th>All Reactions</th>
            <th>Interaction Rate</th>
            <th>Reach per Post</th>
            <th>Impression</th>
            <th>Sentiment</th>
          </tr>
        </thead>
        <tbody>
          {# เงื่อนไข: หากเป็นเพจ Facebook แสดงโพสต์ Facebook #}
          {% if page.platform == "facebook" %}
            {% for post in facebook_posts %}
            <tr>
              <td class="text-center">{{ forloop.counter }}</td>
              <td class="text-start">
                <div class="d-flex align-items-start gap-2">
                  <div class="position-relative d-inline-block" style="width: 28px; height: 28px;">
                    {% if page.profile_pic %}
                    <img src="{{ page.profile_pic }}" class="rounded-circle border border-white" width="28" height="28" style="object-fit: cover;">
                    {% endif %}
                    <img src="{% static 'assets/img/icons/facebooklogo.png' %}" width="12" height="12" class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
                  </div>
                  <div class="d-flex flex-column lh-sm">
                    <span class="text-truncate">{{ page.page_name }}</span>
                    <div class="text-muted small" style="font-size: 0.65rem;">
                      {{ post.post_timestamp_dt|date:"j M Y - H:i" }}
                    </div>
                  </div>
                </div>
              </td>
              <td style="min-width: 220px; max-width: 220px; padding: 6px 8px;">
                <div class="d-flex align-items-start gap-2">
                  <div style="flex-shrink: 0;">
                    {% if post.post_imgs %}
                    <a href="https://www.facebook.com/{{ post.post_id }}" target="_blank">
                      <img src="{{ post.post_imgs.0 }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" />
                    </a>
                    {% else %}
                    <div style="width: 60px; height: 60px; background-color: #f0f0f0; border-radius: 8px;"></div>
                    {% endif %}
                  </div>
                  <a href="https://www.facebook.com/{{ post.post_id }}" target="_blank" class="a-post-link">
                    <div class="fw-normal" style="font-size: 0.75rem; line-height: 1.3; max-height: 3.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; white-space: normal;">
                      {{ post.post_content }}
                    </div>
                  </a>
                </div>
              </td>
              <td class="text-center">{{ post.like_count|default:0 }}</td>
              <td class="text-center">{{ post.comment_count|default:0 }}</td>
              <td class="text-center">{{ post.total_engagement|default:0 }}</td>
              <td class="text-center">{{ post.interaction_rate|default:"0%" }}</td>
              <td class="text-center">{{ post.reach|default:"-" }}</td>
              <td class="text-center">{{ post.impression_per_view|default:"-" }}</td>
              <td class="text-center">{{ post.negative_sentiment_share|default:"0%" }}</td>
            </tr>
            {% endfor %}
          {% elif page.platform == "tiktok" %}
            {# แสดงโพสต์ TikTok #}
            {% for post in tiktok_posts %}
            <tr>
              <td class="text-center">{{ forloop.counter }}</td>
              <td class="text-start">
                <div class="d-flex align-items-start gap-2">
                  <div class="position-relative d-inline-block" style="width: 28px; height: 28px;">
                    {% if post.profile_pic or page.profile_pic %}
                    <img src="{{ post.profile_pic|default:page.profile_pic }}" class="rounded-circle border border-white" width="28" height="28" style="object-fit: cover;">
                    {% endif %}
                    <img src="{% static 'assets/img/icons/tiktoklogo.webp' %}" width="12" height="12" class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
                  </div>
                  <div class="d-flex flex-column lh-sm">
                    <span class="text-truncate">{{ post.page_name }}</span>
                    <div class="text-muted small" style="font-size: 0.65rem;">
                      {{ post.post_timestamp|default:'' }}
                    </div>
                  </div>
                </div>
              </td>
              <td style="min-width: 240px; max-width: 240px; padding: 6px 8px;">
                <div class="d-flex align-items-start gap-2">
                  <div style="flex-shrink: 0;">
                    {% if post.post_imgs %}
                    <a href="{{ post.post_url }}" target="_blank">
                      <img src="{{ post.post_imgs.0 }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" />
                    </a>
                    {% else %}
                    <div style="width: 60px; height: 60px; background-color: #f0f0f0; border-radius: 8px;"></div>
                    {% endif %}
                  </div>
                  <div class="flex-grow-1" style="min-width: 0;">
                    <a href="{{ post.post_url }}" target="_blank" class="a-post-link" style="text-decoration: none; color: inherit;">
                      <div class="fw-normal" style="font-size: 0.75rem; line-height: 1.3; max-height: 3.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; white-space: normal;">
                        {{ post.post_content|default:'' }}
                      </div>
                    </a>
                  </div>
                </div>
              </td>
              <td class="text-center">{{ post.like_count|default:0 }}</td>
              <td class="text-center">{{ post.comment_count|default:0 }}</td>
              <td class="text-center">{{ post.total_engagement|default:0 }}</td>
              <td class="text-center">{{ post.interaction_rate|default:'-' }}</td>
              <td class="text-center">-</td>
              <td class="text-center">-</td>
              <td class="text-center">-</td>
            </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- 📊 Engagement Scatter Chart Section -->
<div class="card shadow-sm border-0 mb-5" style="width: 100%; margin: 0 auto;" id="engagementCard">
  <div class="card-body p-4" style="padding: 1.5rem;">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h5 class="card-title mb-1">Engagement Scatter Chart</h5>
        <span class="text-muted small">{{ start_date }} - {{ end_date }}</span>
      </div>
      <div class="d-flex gap-1">
        <button class="btn-outline-orange btn-sm" onclick="presentCard('engagementCard','Engagement Scatter Chart')">Presentation</button>
        <button class="btn-outline-orange btn-sm" onclick="exportEngagementCSV()">CSV</button>
        <button class="btn-outline-orange btn-sm" onclick="exportEngagementPDF()">PDF</button>
      </div>
    </div>
    <div class="d-flex align-items-center mb-3">
      <span class="badge bg-primary rounded-circle me-2" style="width: 10px; height: 10px;"></span>
      <span class="text-muted small">Reactions, Comments & Shares</span>
    </div>
    <div style="width: 100%; aspect-ratio: 3 / 1;">
      <canvas id="engagementScatterChart" style="width: 100%; height: 100%; display: block;"></canvas>
    </div>
  </div>
</div>


<!-- ✅ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1"></script>

<script>
const ctx = document.getElementById('engagementScatterChart').getContext('2d');

// Retrieve primary color from CSS variables for scatter chart
const primaryColorValue = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#2563eb';
// Use the primary color directly for scatter points to match the overall theme
const scatterColor = primaryColorValue;


// กำหนดแพลตฟอร์มจากฝั่งเซิร์ฟเวอร์
const platform = "{{ page.platform }}";
// Provide fallback page name for use when posts do not include page_name (e.g. grouped JSON)
const pageName = "{{ page.page_name|escapejs }}";

// สร้างข้อมูล scatter สำหรับ Facebook
const scatterDataFacebook = {
  datasets: [{
    label: 'Engagement',
    data: [
      {% for post in facebook_posts %}
        {
          x: new Date("{{ post.post_timestamp_dt|date:'Y-m-d H:i' }}"),
          y: {{ post.total_engagement|default:0 }},
          img: "{{ post.post_imgs.0|default:'' }}",
          content: "{{ post.post_content|truncatewords:20|escapejs }}",
          page_name: "{{ page.page_name|escapejs }}",
          timestamp: "{{ post.post_timestamp_text|escapejs }}",
          link: "https://www.facebook.com/{{ post.post_id }}"
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    // Use the primary color instead of a hard-coded pink hue to match the theme
    backgroundColor: scatterColor,
    pointRadius: 6,
    pointHoverRadius: 8,
  }]
};

// สร้างข้อมูล scatter สำหรับ TikTok
const scatterDataTikTok = {
  datasets: [{
    label: 'Engagement',
    data: [
      {% for post in tiktok_posts %}
        {
          x: {% if post.post_timestamp_dt %}new Date("{{ post.post_timestamp_dt|date:'Y-m-d H:i' }}"){% else %}new Date("{{ post.post_timestamp|default:'' }}"){% endif %},
          y: {{ post.total_engagement|default:0 }},
          img: "{{ post.post_imgs.0|default:'' }}",
          content: "{{ post.post_content|truncatewords:20|escapejs }}",
          page_name: "{{ post.page_name|escapejs }}",
          timestamp: "{{ post.post_timestamp|escapejs }}",
          link: "{{ post.post_url }}"
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    // Use the same primary color for TikTok dataset
    backgroundColor: scatterColor,
    pointRadius: 6,
    pointHoverRadius: 8,
  }]
};

// เลือกข้อมูลตามแพลตฟอร์ม
const scatterData = platform === 'tiktok' ? scatterDataTikTok : scatterDataFacebook;

// 🟢 Dynamic colour scaling for scatter points based on engagement
// Helper to convert hex colour to RGB
function hexToRgb(hex) {
  const clean = hex.replace('#','');
  const bigint = parseInt(clean, 16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return {r, g, b};
}
// Helper to lighten a colour by mixing it with white according to factor (0-1)
function lightenColorJs(hex, factor) {
  const {r, g, b} = hexToRgb(hex);
  const newR = Math.round(r + (255 - r) * factor);
  const newG = Math.round(g + (255 - g) * factor);
  const newB = Math.round(b + (255 - b) * factor);
  return `rgb(${newR}, ${newG}, ${newB})`;
}
// Compute colour for each point: lower engagement => lighter; higher engagement => darker
try {
  const maxY = Math.max(...scatterData.datasets[0].data.map(d => d.y || 0));
  const baseColor = primaryColorValue || '#2563eb';
  const pointColors = scatterData.datasets[0].data.map(d => {
    const ratio = maxY > 0 ? (d.y || 0) / maxY : 0;
    // Lighten factor from 0.8 (lowest) down to 0.2 (highest)
    const factor = 0.8 - 0.6 * ratio;
    return lightenColorJs(baseColor, factor);
  });
  // Assign dynamic colours to scatter points
  scatterData.datasets[0].backgroundColor = pointColors;
} catch (err) {
  // if any error, fallback to single scatter colour
  scatterData.datasets[0].backgroundColor = scatterColor;
}

// ฟังก์ชันแสดง tooltip และการคลิกที่จุดใน scatter chart
const scatterOptions = {
  responsive: true,
  onClick: (e, elements) => {
    if (elements.length > 0) {
      const datasetIndex = elements[0].datasetIndex;
      const pointIndex = elements[0].index;
      const link = scatterData.datasets[datasetIndex].data[pointIndex].link;
      if (link) {
        window.open(link, '_blank');
      }
    }
  },
  plugins: {
    tooltip: {
      enabled: false,
      external: function(context) {
        const tooltipModel = context.tooltip;
        const chart = context.chart;
        let tooltipEl = document.getElementById('chartjs-tooltip');
        if (!tooltipEl) {
          tooltipEl = document.createElement('div');
          tooltipEl.id = 'chartjs-tooltip';
          tooltipEl.innerHTML = '<div class="tooltip-box"></div>';
          document.body.appendChild(tooltipEl);
        }

        if (tooltipModel.opacity === 0) {
          tooltipEl.style.opacity = 0;
          return;
        }

        const dataPoint = tooltipModel.dataPoints[0].raw;
        const html = `
          <div class="d-flex align-items-start gap-2" style="max-width: 500px;">
            <a href="${dataPoint.link}" target="_blank">
              <img src="${dataPoint.img}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px;" />
            </a>
            <div class="flex-grow-1">
              <div style="font-weight: 600; font-size: 14px; color: #111; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${dataPoint.page_name}</div>
              <div style="font-size: 13px; color: #555;">${dataPoint.timestamp}</div>
              <div style="font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px;">${dataPoint.content}</div>
              <div style="font-size: 11px; color: #999; margin-top: 2px;">Total Engagement: ${dataPoint.y}</div>
            </div>
          </div>
        `;
        tooltipEl.querySelector('.tooltip-box').innerHTML = html;
        const position = chart.canvas.getBoundingClientRect();
        const tooltipWidth = 500;
        let left = position.left + window.pageXOffset + tooltipModel.caretX + 10;
        let top = position.top + window.pageYOffset + tooltipModel.caretY + 10;
        const screenWidth = window.innerWidth;
        if (left + tooltipWidth > screenWidth) {
          left = screenWidth - tooltipWidth - 20;
        }
        tooltipEl.style.opacity = 1;
        tooltipEl.style.position = 'absolute';
        tooltipEl.style.left = `${left}px`;
        tooltipEl.style.top = `${top}px`;
        tooltipEl.style.background = 'white';
        tooltipEl.style.border = '1px solid #ddd';
        tooltipEl.style.borderRadius = '8px';
        tooltipEl.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        tooltipEl.style.padding = '10px';
        tooltipEl.style.pointerEvents = 'none';
        tooltipEl.style.fontFamily = 'Inter, sans-serif';
        tooltipEl.style.maxWidth = '500px';
        tooltipEl.style.zIndex = '9999';
      }
    }
  },
  scales: {
    x: {
      type: 'time',
      time: {
        tooltipFormat: 'DD MMM YYYY',
        unit: 'day',
        displayFormats: {
          day: 'DD MMM'
        }
      },
      title: {
        display: true,
        text: 'Date'
      },
      ticks: {
        // Use a medium gray tone defined by our CSS variables for axis labels
        color: '#64748b'
      }
    },
     y: {
    beginAtZero: true,
    suggestedMax: 200,        // หรือค่าสูงสุดของคุณ
    ticks: {
      stepSize: 20,           // ✅ ให้เส้น Y-grid ห่างเท่ากันและตรงกับจุด
      color: '#64748b'
    },
    title: {
      display: true,
      text: 'Engagement'
    },
    grid: {
      // Lighten grid lines to blend better with the minimal theme
      color: '#e2e8f0'
    }
    }
  }
};

// Initialize scatter chart and store instance globally for export/print functions
const engagementChart = new Chart(ctx, {
  type: 'scatter',
  data: scatterData,
  options: scatterOptions
});
window.engagementChart = engagementChart;
</script>

<style>
  #chartjs-tooltip {
  transition: all 0.2s ease;
  max-width: 500px;
  overflow-wrap: break-word;
  word-break: break-word;
  z-index: 9999;
  position: absolute;
}
</style>
<!-- 📊 Number of posts by days & Best Times To Post -->
<div class="row">
<!-- 📊 Number of posts by days -->
<div class="col-md-6">
  <div class="card shadow-sm rounded p-3 mb-4 w-100" style="aspect-ratio: 4 / 2;" id="postsByDayCard">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Posts by Day</h6>
      <div class="d-flex gap-1">
        <button class="btn-outline-orange btn-sm" onclick="presentCard('postsByDayCard','Posts by Day')">Presentation</button>
        <button class="btn-outline-orange btn-sm" onclick="exportPostsByDayCSV()">CSV</button>
        <button class="btn-outline-orange btn-sm" onclick="exportPostsByDayPDF()">PDF</button>
      </div>
    </div>
    <div class="position-relative" style="width: 100%; height: 100%;">
      <canvas id="postsByDayChart" style="width: 100%; height: 100%;"></canvas>
    </div>
  </div>
</div>


<!-- 🧠 Popup Modal -->
<div class="modal fade" id="popupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Posts in Selected By Day</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="popupContent"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const postsByDayChart = new Chart(document.getElementById("postsByDayChart").getContext("2d"), {
    type: "bar",
    data: {
      labels: {{ bar_day_labels|safe }},
      datasets: [{
        label: "Number of posts",
        data: {{ bar_day_values|safe }},
        backgroundColor: {{ bar_day_colors|safe }},
        borderRadius: 6,
        barThickness: 28
      }]
    },
    options: {
      onClick: function (e, elements) {
        if (elements.length > 0) {
          const dayIndex = elements[0].index;
          const postsMap = JSON.parse('{{ posts_by_day_json|escapejs }}');
          const posts = postsMap[dayIndex] || [];

          document.querySelector('#popupModal .modal-title').innerText = 'Posts in Selected By Day';

          // สร้าง HTML สำหรับแต่ละโพสต์ตามแพลตฟอร์ม
          const html = posts.map(p => {
            // Determine the correct platform icon path
            let platformIconPath;
            const plat = p.platform || platform;
            if (plat === 'tiktok') {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/tiktoklogo.webp`;
            } else if (plat === 'instagram') {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/iglogo.png`;
            } else if (plat === 'lemon8') {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/lemon8logo.png`;
            } else if (plat === 'youtube') {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/youtubelogo.png`;
            } else {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/facebooklogo.png`;
            }
            // Interaction HTML based on platform
            let engagementHtml = '';
            if (p.platform === 'tiktok') {
              engagementHtml = `
                <span>❤️ ${p.like_count || 0}</span>
                <span>💬 ${p.comment_count || 0}</span>
                <span>↪ ${p.share_count || 0}</span>
                <span>🔖 ${p.save_count || 0}</span>
                <span class="ms-auto fw-semibold text-dark">👁 ${p.view_count || 0}</span>
              `;
            } else {
              const reactions = Object.entries(p.reactions || {}).map(([r, c]) => {
                const emoji = { 'ถูกใจ': '👍', 'รักเลย': '❤️', 'เศร้า': '😢', 'โกรธ': '😡', 'ว้าว': '😮', 'ฮ่าๆ': '😂', 'ห่วงใย': '🥰' }[r] || '';
                return `<span>${emoji} ${c}</span>`;
              }).join('');
              engagementHtml = `
                ${reactions}
                <span>💬 ${p.comment_count || 0}</span>
                <span>↪ ${p.share_count || 0}</span>
                <span class="ms-auto fw-semibold text-dark">🔥 ${p.total_engagement || 0}</span>
              `;
            }
            // Prepare profile picture and page name with fallbacks
            const pageNameValue = p.page_name || pageName;
            const profilePic = p.profile_pic || window.DEFAULT_PROFILE_PIC;
            const profileAndPlatform = profilePic ? `<div class="position-relative d-inline-block" style="width: 16px; height: 16px;"><img src="${profilePic}" class="rounded-circle border border-white" width="16" height="16" style="object-fit: cover;"><img src="${platformIconPath}" width="8" height="8" class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white"></div>` : '';
            return `
              <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
                <div style="width: 90px; height: 90px; flex-shrink: 0; overflow: hidden;">
                  ${p.post_imgs?.length && p.post_imgs[0] ? `<a href="${p.post_url}" target="_blank"><img src="${p.post_imgs[0]}" class="rounded-start" style="height: 100%; width: 90px; object-fit: cover;" /></a>` : `<div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>`}
                </div>
                <div class="flex-grow-1 px-2 py-1 d-flex flex-column justify-content-between" style="min-width: 0;">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-center gap-2">
                      ${profileAndPlatform}
                      <strong class="text-truncate">${pageNameValue}</strong>
                    </div>
                    <div class="text-muted small" style="font-size: 0.65rem;">${p.post_timestamp}</div>
                  </div>
                  <div class="mt-1 text-dark" style="display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;font-size: 0.8rem;">
                    ${p.post_content}
                  </div>
                  <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                    ${engagementHtml}
                  </div>
                </div>
              </div>
            `;
          }).join('');

          document.getElementById('popupContent').innerHTML = html;
          new bootstrap.Modal(document.getElementById('popupModal')).show();
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0, color: "#485b7d", font: { size: 12, family: "Inter" } },
          grid: { color: "#e0e0e0" }
        },
        x: {
          ticks: { color: "#485b7d", font: { size: 12, family: "Inter" } },
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              return `Posts: ${context.parsed.y}`;
            }
          }
        }
      },
      responsive: true,
      maintainAspectRatio: false
    }
  });
  // Store instance globally for export/print
  window.postsByDayChart = postsByDayChart;
});
</script>


  <!-- 🕒 Best Times To Post -->
  <div class="col-md-6">
    <div class="card shadow-sm rounded p-3 mb-4" style="aspect-ratio: 4 / 2;" id="bestTimesCard">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Best Times To Post</h6>
        <div class="d-flex gap-1">
          <button class="btn-outline-orange btn-sm" onclick="presentCard('bestTimesCard','Best Times To Post')">Presentation</button>
          <button class="btn-outline-orange btn-sm" onclick="exportBestTimesCSV()">CSV</button>
          <button class="btn-outline-orange btn-sm" onclick="exportBestTimesPDF()">PDF</button>
        </div>
      </div>
      <div class="position-relative" style="width: 100%; height: 100%;">
        <canvas id="bestTimesChart"></canvas>
      </div>
    </div>
  </div>
</div>

  <!-- 🧊 Popup Modal -->
<div class="modal fade" id="bestTimesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content rounded">
      <div class="modal-header">
        <h5 class="modal-title fw-semibold">Posts in Selected Time Slot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="bestTimesModalBody">
        <!-- Posts will be injected here -->
      </div>
    </div>
  </div>

<!-- 📽️ Card Presentation Modal for exporting and presenting individual cards -->
<!-- Modal used when presenting charts/cards at full screen -->
<div class="modal fade" id="cardPresentationModal" tabindex="-1" aria-hidden="true">
  <!-- Use full screen dialog so the presented content fills the viewport -->
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-semibold" id="cardPresentationTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <!-- Use flexbox to keep content centered and allow scrolling if the content overflows -->
      <div class="modal-body d-flex justify-content-center align-items-start" id="cardPresentationContent" style="overflow-y:auto;"></div>
    </div>
  </div>
</div>

<script>
// ====================== Export & Presentation Functions ======================
// Generic CSV exporter
function exportToCSV(headers, rows, filename) {
  let csv = '';
  csv += headers.join(',') + '\n';
  rows.forEach(r => {
    csv += r.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',') + '\n';
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Helper: print specific card to PDF
function printCard(cardId, title) {
  const card = document.getElementById(cardId);
  if (!card) {
    window.print();
    return;
  }
  const newWin = window.open('', '', 'width=900,height=600');
  const doc = newWin.document;
  doc.open();
  doc.write('<html><head><title>' + title + '</title>');
  doc.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">');
  doc.write('<style>body{font-family: Montserrat, Prompt, sans-serif;} .card{margin:1rem;} </style>');
  doc.write('</head><body></body></html>');
  doc.close();
  // Clone the card and remove any presentation/export buttons before printing
  const clone = card.cloneNode(true);
  const buttons = clone.querySelectorAll('button');
  buttons.forEach(btn => btn.remove());
  // Replace Chart.js canvases with images generated from their respective chart instances
  const canvasEls = clone.querySelectorAll('canvas');
  canvasEls.forEach(canvas => {
    const id = canvas.id;
    let chartInstance = null;
    if (id === 'engagementScatterChart') {
      chartInstance = window.engagementChart;
    } else if (id === 'postsByDayChart') {
      chartInstance = window.postsByDayChart;
    } else if (id === 'bestTimesChart') {
      chartInstance = window.bestTimesChart;
    }
    if (chartInstance && typeof chartInstance.toBase64Image === 'function') {
      try {
        const imgData = chartInstance.toBase64Image();
        const imgEl = document.createElement('img');
        imgEl.src = imgData;
        imgEl.style.width = canvas.style.width || canvas.width + 'px';
        imgEl.style.height = canvas.style.height || canvas.height + 'px';
        canvas.replaceWith(imgEl);
      } catch (e) {
        // If conversion fails, leave the canvas as is
      }
    }
  });
  // Replace Google Chart (follower line chart) with an image if available
  const followerContainer = clone.querySelector('#followerLineChart');
  if (followerContainer && window.followerLineChart && typeof window.followerLineChart.getImageURI === 'function') {
    try {
      const uri = window.followerLineChart.getImageURI();
      const imgEl = document.createElement('img');
      imgEl.src = uri;
      imgEl.style.width = '100%';
      imgEl.style.height = '100%';
      followerContainer.innerHTML = '';
      followerContainer.appendChild(imgEl);
    } catch (e) {
      // ignore if conversion fails
    }
  }
  newWin.document.body.appendChild(clone);
  setTimeout(() => {
    newWin.focus();
    newWin.print();
    newWin.close();
  }, 500);
}

// Show a card in a modal presentation (convert charts to images)
function presentCard(cardId, title) {
  // Attempt to close any currently open popup modal (e.g. posts list) before presenting
  const popupEl = document.getElementById('popupModal');
  if (popupEl) {
    const existing = bootstrap.Modal.getInstance(popupEl);
    if (existing) {
      existing.hide();
    }
  }
  const card = document.getElementById(cardId);
  if (!card) return;
  const modalTitleEl = document.getElementById('cardPresentationTitle');
  const modalBodyEl = document.getElementById('cardPresentationContent');
  if (modalTitleEl) modalTitleEl.textContent = title;
  if (modalBodyEl) {
    modalBodyEl.innerHTML = '';
    const canvases = card.querySelectorAll('canvas');
    let converted = false;
    if (canvases.length > 0) {
      canvases.forEach(cv => {
        try {
          const img = document.createElement('img');
          img.src = cv.toDataURL('image/png');
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          img.classList.add('mb-3');
          modalBodyEl.appendChild(img);
          converted = true;
        } catch (err) {
          // When conversion fails (e.g. due to CORS-tainted canvas), we will fallback below
          console.error('Error converting canvas to image', err);
        }
      });
    }
    // Fallback: if no canvases or conversion failed, clone the card content without buttons
    if (!converted) {
      const clone = card.cloneNode(true);
      clone.querySelectorAll('button').forEach(btn => btn.remove());
      // Try to only extract the card-body for cleaner presentation
      const body = clone.querySelector('.card-body');
      if (body) {
        modalBodyEl.appendChild(body.cloneNode(true));
      } else {
        modalBodyEl.appendChild(clone);
      }
    }
  }
  const modal = new bootstrap.Modal(document.getElementById('cardPresentationModal'));
  modal.show();
}

// Export Engagement Scatter Chart
function exportEngagementCSV() {
  try {
    const data = JSON.parse(`{{ scatter_data_json|safe }}`);
    const headers = ['Timestamp','Engagement','Content','Page'];
    const rows = data.map(d => [d.x, d.y, (d.content || '').replace(/\n/g,' ').replace(/\r/g,''), d.page_name || '']);
    exportToCSV(headers, rows, 'engagement_scatter.csv');
  } catch (err) {
    console.error(err);
  }
}
function exportEngagementPDF() {
  printCard('engagementCard', 'Engagement Scatter Chart');
}

// Export Posts By Day
function exportPostsByDayCSV() {
  const labels = JSON.parse(`{{ bar_day_labels|safe }}`);
  const values = JSON.parse(`{{ bar_day_values|safe }}`);
  const headers = ['Day','Posts'];
  const rows = labels.map((d,i) => [d, values[i]]);
  exportToCSV(headers, rows, 'posts_by_day.csv');
}
function exportPostsByDayPDF() {
  printCard('postsByDayCard', 'Posts by Day');
}

// Export Best Times
function exportBestTimesCSV() {
  const data = JSON.parse(`{{ bubble_data|safe }}`);
  const headers = ['Label','DayIndex','Hour','Posts','Likes','Comments','Shares'];
  const rows = data.map(b => [b.tooltip_label || b.label, b.x, b.y, b.count, b.likes, b.comments, b.shares]);
  exportToCSV(headers, rows, 'best_times.csv');
}
function exportBestTimesPDF() {
  printCard('bestTimesCard', 'Best Times To Post');
}

// Export Top Posts
function exportTopPostsCSV() {
  try {
    const data = JSON.parse(`{{ top_posts_json|safe }}`);
    if (!Array.isArray(data)) return;
    const headers = ['Platform','Post ID/URL','Post Content','Timestamp','Likes','Comments','Shares','Saves','Views','Engagement Rate','Page Name'];
    const rows = data.map(p => {
      const postIdOrUrl = p.platform === 'tiktok' ? (p.post_url || '') : (p.post_id || '');
      return [
        p.platform,
        postIdOrUrl,
        (p.post_content || '').replace(/\n/g,' ').replace(/\r/g,''),
        p.post_timestamp,
        p.like_count || 0,
        p.comment_count || 0,
        p.share_count || 0,
        p.save_count || 0,
        p.view_count || 0,
        p.engagement_rate,
        p.page_name || ''
      ];
    });
    exportToCSV(headers, rows, 'top_posts.csv');
  } catch (err) {
    console.error(err);
  }
}
function exportTopPostsPDF() {
  printCard('topPostsCard', 'Top Posts by Engagement');
}

// Export Page Info (summary)
function exportPageInfoCSV() {
  try {
    const headers = ['Property','Value'];
    const rows = [];
    rows.push(['Page Name', '{{ page.page_name|escapejs }}']);
    rows.push(['Page Username', '{{ page.page_username|escapejs }}']);
    // Include category only for facebook pages
    {% if page.platform == 'facebook' %}
    rows.push(['Page Categories', '{{ page.page_category|default:"-"|escapejs }}']);
    {% endif %}
    rows.push(['Page Website', '{{ page.page_website|default:"-"|escapejs }}']);
    rows.push(['Page Email', '{{ page.page_email|default:"-"|escapejs }}']);
    rows.push(['Page Number', '{{ page.page_number|default:"-"|escapejs }}']);
    rows.push(['Page Address', '{{ page.page_address|default:"-"|escapejs }}']);
    rows.push(['Followers', '{{ page.page_followers_count|default:0 }}']);
    rows.push(['Likes', '{{ page.page_likes_count|default:0 }}']);
    exportToCSV(headers, rows, 'page_info.csv');
  } catch (err) {
    console.error(err);
  }
}
function exportPageInfoPDF() {
  printCard('pageInfoCard', 'Page Information');
}

// Export Follower Chart
function exportFollowerCSV() {
  try {
    const data = JSON.parse(`{{ follower_data_json|safe }}`);
    const headers = ['Date','Followers'];
    const rows = data.map(d => [d.date, d.followers]);
    exportToCSV(headers, rows, 'followers_by_date.csv');
  } catch (err) {
    console.error(err);
  }
}
function exportFollowerPDF() {
  printCard('followerCard', 'Follower Line Chart');
}

// Export Hashtags Wordcloud
function exportHashtagsCSV() {
  try {
    const data = JSON.parse(`{{ top_hashtags_json|safe }}`);
    const headers = ['Hashtag','Count'];
    const rows = data.map(d => [d.tag, d.count]);
    exportToCSV(headers, rows, 'top_hashtags.csv');
  } catch (err) {
    console.error(err);
  }
}
function exportHashtagsPDF() {
  printCard('hashtagCard', 'Top 50 Hashtags');
}
</script>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ✅ Bubble Chart: Best Times To Post -->
<script>
// ตั้งค่าตำแหน่ง STATIC_URL เพื่อใช้ประกอบเส้นทางรูปไอคอนในสคริปต์
window.STATIC_URL = "{% static '' %}";
// เก็บรูปโปรไฟล์ของเพจเป็น default หากแต่ละโพสต์ไม่มี profile_pic เฉพาะตัว
window.DEFAULT_PROFILE_PIC = "{{ page.profile_pic|default:'' }}";
document.addEventListener("DOMContentLoaded", function () {
  function getColorByPostCount(count) {
    const max = 30;
    const ratio = Math.min(count / max, 1);
    const hue = (1 - ratio) * 240;
    // Use colours similar to group_detail: adjust saturation and lightness
    return `hsl(${hue}, 70%, 65%)`;
  }

  const bubbles = JSON.parse('{{ bubble_data|escapejs }}');
  const postMap = JSON.parse('{{ posts_grouped_json|escapejs }}');

  const ctx = document.getElementById("bestTimesChart").getContext("2d");
  const bestTimesChart = new Chart(ctx, {
    type: 'bubble',
    data: {
      datasets: bubbles.map(b => ({
        data: [{
          x: b.x, y: b.y, r: b.r,
          count: b.count,
          likes: b.likes,
          comments: b.comments,
          shares: b.shares,
          key: b.key,
          label: b.tooltip_label
        }],
        backgroundColor: getColorByPostCount(b.count),
        hoverBackgroundColor: getColorByPostCount(b.count)
      }))
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => [
              ctx.raw.label,
              `${ctx.raw.count} Number of posts`,
              `${ctx.raw.likes} Likes, ${ctx.raw.comments} Comments, ${ctx.raw.shares} Shares`
            ]
          }
        },
        legend: { display: false }
      },
      scales: {
        x: {
          min: -0.5, max: 6.5,
          ticks: { callback: v => ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][v] }
        },
        y: { min: 0, max: 24, ticks: { stepSize: 2 } }
      },
        onClick: (e, elements) => {
        if (elements.length) {
          const key = bestTimesChart.data.datasets[elements[0].datasetIndex].data[0].key;
          const posts = postMap[key] || [];

          document.querySelector('#popupModal .modal-title').innerText = 'Posts in Selected Time Slot';

          // แสดงโพสต์ทั้งหมดในช่วงเวลาที่เลือก โดยใช้แพลตฟอร์มกำหนดไอคอนและปฏิสัมพันธ์
          const html = posts.map(p => {
            // เตรียมรูปโปรไฟล์เพจและไอคอนแพลตฟอร์ม (แบบซ้อนทับคล้าย group_detail)
            const plat2 = p.platform || platform;
            let platformIconPath;
            if (plat2 === 'tiktok') {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/tiktoklogo.webp`;
            } else if (plat2 === 'instagram') {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/iglogo.png`;
            } else if (plat2 === 'lemon8') {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/lemon8logo.png`;
            } else if (plat2 === 'youtube') {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/youtubelogo.png`;
            } else {
              platformIconPath = `${window.STATIC_URL}assets/img/icons/facebooklogo.png`;
            }

            // ปฏิสัมพันธ์ตามแพลตฟอร์ม
            let engagementHtml = '';
            if (p.platform === 'tiktok') {
              engagementHtml = `
                <span>❤️ ${p.like_count || 0}</span>
                <span>💬 ${p.comment_count || 0}</span>
                <span>↪ ${p.share_count || 0}</span>
                <span>🔖 ${p.save_count || 0}</span>
                <span class="ms-auto fw-semibold text-dark">👁 ${p.view_count || 0}</span>
              `;
            } else {
              const reactions = Object.entries(p.reactions || {}).map(([reaction, count]) => {
                const emoji = { 'ถูกใจ':'👍', 'รักเลย':'❤️', 'เศร้า':'😢', 'โกรธ':'😡', 'ว้าว':'😮', 'ฮ่าๆ':'😂', 'ห่วงใย':'🥰' }[reaction] || '';
                return `<span>${emoji} ${count}</span>`;
              }).join('');
              engagementHtml = `
                ${reactions}
                <span>💬 ${p.comment_count || 0}</span>
                <span>↪ ${p.share_count || 0}</span>
                <span class="ms-auto fw-semibold text-dark">🔥 ${p.total_engagement || 0}</span>
              `;
            }

            return `
              <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
                <div style="width: 90px; height: 90px; flex-shrink: 0; overflow: hidden;">
                  ${p.post_imgs?.length && p.post_imgs[0] ? `<a href="${p.post_url}" target="_blank"><img src="${p.post_imgs[0]}" style="height: 100%; width: 90px; object-fit: cover;" class="rounded-start" /></a>` : `<div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>`}
                </div>
                <div class="flex-grow-1 px-2 py-1 d-flex flex-column justify-content-between" style="min-width: 0;">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-center gap-2">
                      ${p.profile_pic || window.DEFAULT_PROFILE_PIC ? `<div class="position-relative d-inline-block" style="width: 24px; height: 24px;"><img src="${p.profile_pic || window.DEFAULT_PROFILE_PIC}" class="rounded-circle border border-white" width="24" height="24" style="object-fit: cover;"><img src="${platformIconPath}" width="10" height="10" class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white"></div>` : ''}
                      <strong class="text-truncate">${p.page_name || pageName}</strong>
                    </div>
                    <div class="text-muted small" style="font-size: 0.65rem;">${p.post_timestamp || ''}</div>
                  </div>
                  <div class="mt-1 text-dark" style="display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;font-size: 0.8rem;">
                    ${p.post_content || ''}
                  </div>
                  <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                    ${engagementHtml}
                  </div>
                </div>
              </div>
            `;
          }).join('');

          document.getElementById('popupContent').innerHTML = html;
          new bootstrap.Modal(document.getElementById('popupModal')).show();
        }
      }
    }
  });
  // Store instance globally for export/print
  window.bestTimesChart = bestTimesChart;
});
</script>

<!-- 👥 Follower Line Chart & 🔠 Top 50 Hashtags -->
<div class="row">
  <!-- 👥 Follower Line Chart -->
  <div class="col-md-6">
    <!-- Follower Line Chart Card with export & presentation controls -->
    <div id="followerCard" class="card shadow-sm border-0 mb-4" style="aspect-ratio: 4 / 2;">
      <div class="card-body p-4 d-flex flex-column justify-content-between" style="height: 450px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="card-title mb-0">Follower Line Chart</h5>
            <span class="text-muted small">{{ start_date }} - {{ end_date }}</span>
          </div>
          <div class="d-flex gap-2">
            <button class="btn-outline-orange" onclick="presentCard('followerCard','Follower Line Chart')">Present</button>
            <button class="btn-outline-orange" onclick="exportFollowerCSV()">CSV</button>
            <button class="btn-outline-orange" onclick="exportFollowerPDF()">PDF</button>
          </div>
        </div>
        <div class="d-flex align-items-center mb-3">
          <span class="badge bg-success rounded-circle me-2" style="width: 10px; height: 10px;"></span>
          <span class="text-muted small">Number of followers per day</span>
        </div>
        <div style="flex-grow: 1; position: relative;">
          <div id="followerLineChart" style="width: 100%; height: 100%;"></div>
        </div>
      </div>
    </div>
  </div>


<!-- ✅ Google Chart Library -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(drawFollowerChart);

  function drawFollowerChart() {
    // If no follower data, display a message instead of rendering an empty chart
    const followerDataLength = {{ follower_data|length }};
    const container = document.getElementById('followerLineChart');
    if (followerDataLength === 0) {
      if (container) {
        container.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100 text-muted">No follower data available</div>';
      }
      return;
    }
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Date');
    data.addColumn('number', 'Follower');
    data.addRows([
      {% for row in follower_data %}
        ['{{ row.date }}', {{ row.followers }}]{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]);
    const options = {
      chartArea: { left: 60, top: 30, width: '92%', height: '80%' },
      fontName: 'Inter',
      legend: { position: 'none' },
      series: { 0: { color: '#2563eb' } },
      hAxis: {
        textStyle: { color: '#485B7D', fontSize: 12 },
        baselineColor: '#485B7D'
      },
      vAxis: {
        format: 'decimal',
        textStyle: { color: '#485B7D', fontSize: 12 },
        baselineColor: '#485B7D',
        gridlines: { color: '#dce1eb', count: 4 }
      }
    };
    const chart = new google.visualization.LineChart(container);
    chart.draw(data, options);
    // Store global reference for export/print functions
    window.followerLineChart = chart;
  }
</script>

<!-- 🔠 Top 50 Hashtags Wordcloud (แบบ Fanpage Karma) -->
<div class="col-md-6">
  <!-- Top 50 Hashtags Card with export & presentation controls -->
  <div id="hashtagCard" class="card shadow-sm border-0 mb-4" style="height: 450px;">
    <div class="card-body p-4 d-flex flex-column justify-content-between h-100">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h5 class="mb-2">Top 50 Hashtags by Posts</h5>
          <p class="text-muted small mb-0">The bigger the word, the more it was used. The greener, the more these posts were interacted with.</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn-outline-orange" onclick="presentCard('hashtagCard','Top 50 Hashtags')">Present</button>
          <button class="btn-outline-orange" onclick="exportHashtagsCSV()">CSV</button>
          <button class="btn-outline-orange" onclick="exportHashtagsPDF()">PDF</button>
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2 overflow-auto" id="hashtagCloudBox" style="max-height: 260px;">
        {% for tag in top_hashtags %}
          <a href="#" class="fw-medium" style="font-size: {{ tag.font_size }}em; color: hsl({{ tag.color_hue }}, 60%, 50%); text-decoration: none; line-height: 1.2em;">
            {{ tag.tag }}
          </a>
        {% endfor %}
      </div>
      <div class="analytics_chartLegend mt-3 small text-muted">
        <div class="analytics_chartLegendItem">size = frequency</div>
        <div class="analytics_chartLegendItemGreen">green = high engagement</div>
        <div class="analytics_chartLegendItemRed">red = low engagement</div>
      </div>
    </div>
  </div>
</div>
</div>
</div>
{% endblock %}