{% extends 'base2.html' %}
{% load static %}
{% load humanize %}
{% block content %}
    <!-- 🔸 หัวข้อกลุ่ม + ปุ่ม Add Page -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">{{ group.group_name }}</h3>
      <form method="POST" action="{% url 'add_page' group.id %}">
        {% csrf_token %}
        <div class="d-flex">
          {{ form.url }} <!-- หรือถ้าต้องการซ่อน input url ไว้ใช้เป็น hidden ได้ -->
          <button type="submit" class="btn text-white fw-semibold" style="
            background-color: #ff6f00;  /* สีส้มแบบปุ่ม Add Group For Page */
            border: none;
            border-radius: 8px;
            padding: 8px 16px;">
            Add Page
          </button>
        </div>
      </form>
    </div>

    <!-- 🔹 ตาราง All Page Metric Overview (ตามที่ทำไปแล้ว) -->
    {% if pages %}
    <div class="card shadow-sm rounded mb-4 w-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Page Metric Overview</h5>
        <input type="text" placeholder="Search Page" class="form-control w-25">
      </div>
      <div class="table-responsive">
  <table class="table table-striped align-middle text-center">
    <thead class="table-light">
      <tr>
        <th scope="col">Page</th>
        <th scope="col">Followers</th>

        {# Show specific columns depending on platform #}
        {% if pages|length > 0 and pages.0.platform == "youtube" %}
          <th scope="col">Likes</th>
          <th scope="col">Videos</th>
        {% else %}
          <th scope="col">Likes</th>
          <th scope="col">Talking</th>
        {% endif %}

        <th scope="col">Website</th>
        <th scope="col">Email</th>
        <th scope="col">Phone</th>
      </tr>
    </thead>

<tbody>
{% for page in pages %}
<tr>
<td class="d-flex align-items-center">
  <!-- 🔵 Profile Picture + Platform Icon -->
  <div class="position-relative me-2" style="width: 40px; height: 40px;">
    {% if page.profile_pic %}
      <img src="{{ page.profile_pic }}" class="rounded-circle border border-white"
           width="40" height="40" style="object-fit: cover;">
    {% else %}
      <img src="{% static 'assets/img/icons/default_profile.png' %}" class="rounded-circle border border-white"
           width="40" height="40" style="object-fit: cover;">
    {% endif %}

    <!-- ✅ Platform Icon -->
    {% if page.platform == "facebook" %}
      <img src="{% static 'assets/img/icons/facebooklogo.png' %}" width="12" height="12"
           class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
    {% elif page.platform == "tiktok" %}
      <img src="{% static 'assets/img/icons/tiktoklogo.webp' %}" width="12" height="12"
           class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
    {% elif page.platform == "instagram" %}
      <img src="{% static 'assets/img/icons/iglogo.png' %}" width="12" height="12"
           class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
    {% elif page.platform == "lemon8" %}
      <img src="{% static 'assets/img/icons/lemon8logo.png' %}" width="12" height="12"
           class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
    {% elif page.platform == "youtube" %}
      <img src="{% static 'assets/img/icons/youtubelogo.png' %}" width="12" height="12"
           class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
    {% endif %}
  </div>

  <!-- 🔗 Page Name -->
  <div class="text-start">
    <a href="{% url 'pageview' page.id %}" class="page-name-link">
      {{ page.page_name|default:page.page_username }}
    </a>
  </div>
</td>


  <!-- Followers -->
  <td class="hover-count">
    <span class="short">{{ page.page_followers|intcomma|default:"-" }}</span>
    <span class="full">{{ page.page_followers_count|intcomma|default:"-" }}</span>
  </td>

  <!-- Likes หรือค่าที่แพลตฟอร์มอื่นใช้ -->
  <td class="hover-count">
    <span class="short">
      {% if page.platform == "lemon8" %}
        {{ page.page_likes|default:"-" }}
      {% else %}
        {{ page.page_likes|intcomma|default:"-" }}
      {% endif %}
    </span>
    <span class="full">
      {% if page.platform == "lemon8" %}
        {{ page.page_likes|default:"-" }}
      {% else %}
        {{ page.page_likes_count|intcomma|default:"-" }}
      {% endif %}
    </span>
  </td>

  <style>
  .hover-count .full {
    display: none;
    background-color: black;
    color: white;
    padding: 2px 5px;
    border-radius: 4px;
  }
  .hover-count:hover .short {
    display: none;
  }
  .hover-count:hover .full {
    display: inline;
  }
  </style>

  <!-- Talking/Videos, Website, Email, Phone -->
  {% if page.platform == "facebook" %}
    <td>{{ page.page_talking_count|default:"0" }}</td>
    <td>
      {% if page.page_website %}
        <a href="https://{{ page.page_website|lower }}" target="_blank" class="page-name-link" style="font-weight: bold;">
          {{ page.page_website }}
        </a>
      {% else %}
        -
      {% endif %}
    </td>
    <td><a href="mailto:{{ page.page_email }}" class="page-name-link">{{ page.page_email|default:"-" }}</a></td>
    <td>{{ page.page_phone|default:"-" }}</td>
  {% elif page.platform == "instagram" %}
    <td>-</td>
    <td><a href="{{ page.page_website }}" target="_blank">{{ page.page_website|default:"-" }}</a></td>
    <td>-</td>
    <td>-</td>
  {% elif page.platform == "lemon8" %}
    <td>-</td>
    <td><a href="{{ page.page_website }}" target="_blank">{{ page.page_website|default:"-" }}</a></td>
    <td>-</td>
    <td>-</td>
  {% elif page.platform == "youtube" or page.platform == "tiktok" %}
    <td>{{ page.page_videos_count|default:"-" }}</td>
    <td><a href="{{ page.page_website }}" target="_blank">{{ page.page_website|default:"-" }}</a></td>
    <td>-</td>
    <td>-</td>
  {% else %}
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td>-</td>
  {% endif %}
</tr>
{% endfor %}
</tbody>
        </table>
      </div>
    </div>
    {% else %}
    <p class="text-muted">Add Page to see Overview Dashboard</p>
    {% endif %}
  </div>

  <!-- 🧊 Grid Row สำหรับสองกราฟ -->
  <!-- ✅ Layout: 2 แถว แถวละ 2 การ์ด (ความสูงเท่ากันทั้งหมด 460px) -->
<div class="row">
  <!-- 🔴 Profiles with the most followers -->
  <div class="col-md-6 d-flex">
    <div class="card shadow-sm border-0 p-4 w-100" style="height: 460px;">
      <h6 class="mb-3 fw-semibold">Profiles with the most followers</h6>
      <div class="position-relative" style="width: 100%; height: 360px;">
        <canvas id="followersBarChart"></canvas>
        <div id="chartOverlays" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2;"></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="followersPostsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content rounded">
      <div class="modal-header">
        <h5 class="modal-title fw-semibold">Posts by Selected Page</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="followersPostsModalBody"></div>
    </div>
  </div>
</div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ✅ Custom Tooltip Style -->
  <style>
    canvas#followersBarChart {
      z-index: 1;
      position: relative;
    }

    #external-tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 8px 12px;
      font-size: 13px;
      font-family: 'Inter';
      border-radius: 6px;
      pointer-events: none;
      z-index: 9999;
      white-space: nowrap;
    }
  </style>

<script>
const chartData = JSON.parse(`{{ chart_data_json|safe }}`);
const labels = chartData.map(p => p.name);
const data = chartData.map(p => p.followers);
const colors = chartData.map(p => p.color);

const ctx = document.getElementById('followersBarChart').getContext('2d');

const followersChart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [{
      data: data,
      backgroundColor: colors,
      borderRadius: 6,
      barThickness: 20
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: {
      padding: { top: 20 }
    },
    plugins: {
      legend: { display: false },
      tooltip: {
        enabled: false,
        external: function (context) {
          let tooltipEl = document.getElementById('external-tooltip');
          if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.id = 'external-tooltip';
            document.body.appendChild(tooltipEl);
          }

          const tooltipModel = context.tooltip;
          if (tooltipModel.opacity === 0) {
            tooltipEl.style.opacity = 0;
            return;
          }

          const point = tooltipModel.dataPoints[0];
          const label = point.label;
          const value = point.raw.toLocaleString() + ' followers';

          tooltipEl.innerHTML = `<strong>${label}</strong><br>${value}`;
          tooltipEl.style.opacity = 1;

          const canvasRect = context.chart.canvas.getBoundingClientRect();
          tooltipEl.style.left = canvasRect.left + window.scrollX + tooltipModel.caretX + 'px';
          tooltipEl.style.top = canvasRect.top + window.scrollY + tooltipModel.caretY - 70 + 'px';
        }
      }
    },
    onClick: function (evt, elements) {
      if (elements.length > 0) {
        const index = elements[0].index;
        const page = chartData[index];
        const postsMap = JSON.parse(`{{ followers_posts_map|escapejs }}`);
        const posts = postsMap[page.id] || [];

        const html = posts.map(p => `
          <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
            <div style="width: 90px; height: 90px; flex-shrink: 0; overflow: hidden;">
              ${p.post_imgs?.[0] ? `<a href="https://www.facebook.com/${p.post_id}" target="_blank">
                <img src="${p.post_imgs[0]}" style="height: 100%; width: 90px; object-fit: cover;" class="rounded-start" /></a>` :
                `<div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>`}
            </div>
            <div class="flex-grow-1 px-2 py-1 d-flex flex-column justify-content-between" style="min-width: 0;">
              <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex align-items-center gap-2">
                  ${p.page?.profile_pic ? `<img src="${p.page.profile_pic}" class="rounded-circle" style="width: 16px; height: 16px;">` : ''}
                  <i class="bi bi-facebook text-primary"></i>
                  <strong class="text-truncate">${p.page?.page_name || 'Unnamed'}</strong>
                </div>
                <div class="text-muted small" style="font-size: 0.65rem;">${p.post_timestamp}</div>
              </div>
              <div class="mt-1 text-dark" style="display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;font-size: 0.8rem;">
                ${p.post_content || ''}
              </div>
              <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                ${Object.entries(p.reactions || {}).map(([reaction, count]) => {
                  const emoji = { 'ถูกใจ':'👍', 'รักเลย':'❤️', 'เศร้า':'😢', 'โกรธ':'😡', 'ว้าว':'😮', 'ฮ่าๆ':'😂', 'ห่วงใย':'🥰' }[reaction] || '';
                  return `<span>${emoji} ${count}</span>`;
                }).join('')}
                <span>💬 ${p.comment_count || 0}</span>
                <span>↪ ${p.share_count || 0}</span>
                <span class="ms-auto fw-semibold text-dark">🔥 ${p.total_engagement || 0}</span>
              </div>
            </div>
          </div>
        `).join('');

        document.getElementById('followersPostsModalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('followersPostsModal')).show();
      }
    },
    animation: {
      onComplete: function () {
        const meta = followersChart.getDatasetMeta(0);
        const overlays = document.getElementById('chartOverlays');
        overlays.innerHTML = '';

        meta.data.forEach((bar, i) => {
          const x = bar.x;
          const y = bar.y;
          const page = chartData[i];
          if (!page || !page.profile_pic || !page.platform) return;

          const wrapper = document.createElement('div');
          wrapper.style.position = 'absolute';
          wrapper.style.left = (x - 18) + 'px';
          wrapper.style.top = (y - 44) + 'px';
          wrapper.style.width = '36px';
          wrapper.style.height = '36px';

          const img = document.createElement('img');
          img.src = page.profile_pic;
          img.style.width = '36px';
          img.style.height = '36px';
          img.style.borderRadius = '50%';
          img.style.border = '2px solid white';
          img.style.boxShadow = '0 1px 2px rgba(0,0,0,0.15)';
          wrapper.appendChild(img);

          const icon = document.createElement('img');
          if (page.platform === "facebook")
            icon.src = "{% static 'assets/img/icons/facebook-icon.webp' %}";
          else if (page.platform === "tiktok")
            icon.src = "{% static 'assets/img/icons/tiktoklogo.webp' %}";
          else if (page.platform === "instagram")
            icon.src = "{% static 'assets/img/icons/iglogo.png' %}";
          else if (page.platform === "lemon8")
            icon.src = "{% static 'assets/img/icons/lemon8logo.png' %}";
          else if (page.platform === "youtube")
            icon.src = "{% static 'assets/img/icons/youtubelogo.png' %}";

          icon.style.width = '14px';
          icon.style.height = '14px';
          icon.style.position = 'absolute';
          icon.style.bottom = '0';
          icon.style.right = '0';
          icon.style.borderRadius = '50%';
          icon.style.border = '1px solid white';
          icon.style.backgroundColor = 'white';
          wrapper.appendChild(icon);

          overlays.appendChild(wrapper);
        });
      }
    },
    scales: {
      x: {
        ticks: {
          color: '#2b2c40',
          font: { size: 11 },
          maxRotation: 0,
          minRotation: 0
        },
        grid: { display: false }
      },
      y: {
        beginAtZero: true,
        suggestedMax: Math.max(...data) * 1.2,
        ticks: {
          color: '#adb5bd',
          font: { size: 12 },
          callback: value => value.toLocaleString()
        },
        grid: {
          color: '#e9ecef',
          drawBorder: false
        }
      }
    }
  }
});
</script>




  <!-- 🟡 Share of Interaction -->
  <div class="col-md-6 d-flex">
    <div class="card shadow-sm border-0 p-4 w-100 d-flex flex-column">
      <div>
        <h6 class="mb-1 fw-semibold" style="font-size: 18px;">Share of Interaction</h6>
        <p class="text-muted" style="font-size: 14px;">Which profile got the most interactions on their posts?</p>
      </div>
      <div id="shareInteractionChart" style="width: 100%; height: 100%;"></div>
    </div>
  </div>
</div>

          <br>

<!-- 🧊 Modal: Posts by Selected Page -->
<div class="modal fade" id="interactionPostsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-semibold">Posts by Selected Page</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="interactionPostsContent">
        <!-- Injected Posts -->
      </div>
    </div>
  </div>
</div>

<!-- Google Charts API -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
  google.charts.load("current", { packages: ["corechart"] });
  google.charts.setOnLoadCallback(drawShareInteractionChart);

  function drawShareInteractionChart() {
    const interactionData = JSON.parse(`{{ interaction_data_json|safe }}`);
    const postsMap = JSON.parse(`{{ followers_posts_map|escapejs }}`);
    const chartDiv = document.getElementById('shareInteractionChart');

    const dataArray = [['Page', 'Interactions', { role: 'tooltip', p: { html: true } }, { role: 'style' }]];
    interactionData.forEach((p, i) => {
      const tooltip = `<div style='padding:6px 8px'><b>${p.name}</b><br>${p.interactions} interactions</div>`;
      dataArray.push([p.name, p.interactions, tooltip, `color: ${p.color}`]);
    });

    const data = google.visualization.arrayToDataTable(dataArray);

    const options = {
      pieHole: 0.65,
      tooltip: { isHtml: true },
      legend: { position: 'labeled', textStyle: { fontSize: 13, color: '#333' } },
      pieSliceText: 'none',
      colors: interactionData.map(p => p.color),
      chartArea: { width: '85%', height: '90%' },
      fontName: 'Inter',
      animation: { duration: 500, easing: 'out' },
      backgroundColor: 'transparent'
    };

    const chart = new google.visualization.PieChart(chartDiv);
    chart.draw(data, options);

    // Click Event for Slice
    google.visualization.events.addListener(chart, 'select', () => {
      const selectedItem = chart.getSelection()[0];
      if (selectedItem) {
        const pageName = data.getValue(selectedItem.row, 0);
        const pageObj = interactionData.find(p => p.name === pageName);
        const pageId = pageObj ? pageObj.id || null : null;
        const posts = postsMap[pageId] || [];

        document.querySelector('#interactionPostsModal .modal-title').innerText = `Posts by ${pageName}`;

        const html = posts.map(p => `
          <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
            <div style="width: 90px; height: 90px; flex-shrink: 0; overflow: hidden;">
              ${p.post_imgs?.[0] ? `<a href="https://www.facebook.com/${p.post_id}" target="_blank">
              <img src="${p.post_imgs[0]}" style="height: 100%; width: 90px; object-fit: cover;" class="rounded-start" /></a>` :
              `<div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>`}
            </div>
            <div class="flex-grow-1 px-2 py-1 d-flex flex-column justify-content-between" style="min-width: 0;">
              <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex align-items-center gap-2">
                  ${p.page?.profile_pic ? `<img src="${p.page.profile_pic}" class="rounded-circle" style="width: 16px; height: 16px;">` : ''}
                  <i class="bi bi-facebook text-primary"></i>
                  <strong class="text-truncate">${p.page?.page_name || 'Unnamed'}</strong>
                </div>
                <div class="text-muted small" style="font-size: 0.65rem;">${p.post_timestamp}</div>
              </div>
              <div class="mt-1 text-dark" style="display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;font-size: 0.8rem;">
                ${p.post_content || ''}
              </div>
              <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                ${Object.entries(p.reactions || {}).map(([r, c]) => {
                  const emoji = { 'ถูกใจ': '👍', 'รักเลย': '❤️', 'เศร้า': '😢', 'โกรธ': '😡', 'ว้าว': '😮', 'ฮ่าๆ': '😂', 'ห่วงใย': '🥰' }[r] || '';
                  return `<span>${emoji} ${c}</span>`;
                }).join('')}
                <span>💬 ${p.comment_count || 0}</span>
                <span>↪ ${p.share_count || 0}</span>
                <span class="ms-auto fw-semibold text-dark">🔥 ${p.total_engagement || 0}</span>
              </div>
            </div>
          </div>
        `).join('');

        document.getElementById('interactionPostsContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('interactionPostsModal')).show();
      }
    });

    window.addEventListener('resize', drawShareInteractionChart);
  }
</script>


  <!-- 📊 Number of posts by days & Best Times To Post -->
  <div class="row">
    <!-- 📊 Number of posts by days -->
    <div class="col-md-6 d-flex">
      <div class="card shadow-sm border-0 p-4 w-100">
        <h6 class="mb-3">Number of posts by days</h6>
        <canvas id="postsByDayChart" style="width:100%; height:100%;"></canvas>
      </div>
    </div>
   <!-- 🧠 Popup Modal -->
  <div class="modal fade" id="popupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">Posts in Selected By Day</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="popupContent"></div>
      </div>
    </div>
  </div>

    <script>
  document.addEventListener("DOMContentLoaded", function () {
    // กำหนด STATIC_URL เพื่ออ้างอิงไอคอนของแต่ละแพลตฟอร์ม
    window.STATIC_URL = "{% static '' %}";
    // default profile pic for posts without profile pic
    const defaultProfilePic = `${window.STATIC_URL}assets/img/icons/default_profile.png`;

    const postsByDayChart = new Chart(document.getElementById("postsByDayChart").getContext("2d"), {
      type: "bar",
      data: {
        labels: {{ bar_day_labels|safe }},
        datasets: [{
          label: "Number of posts",
          data: {{ bar_day_values|safe }},
          backgroundColor: {{ bar_day_colors|safe }},
          borderRadius: 6,
          barThickness: 28
        }]
      },
      options: {
        onClick: function (e, elements) {
          if (elements.length > 0) {
            const dayIndex = elements[0].index;
            const postsMap = JSON.parse('{{ posts_by_day_json|escapejs }}');
            const posts = postsMap[dayIndex] || [];

            document.querySelector('#popupModal .modal-title').innerText = 'Posts in Selected By Day';

            // สร้าง HTML สำหรับแต่ละโพสต์ตามแพลตฟอร์ม
            const html = posts.map(p => {
              // ระบุไอคอนแพลตฟอร์ม
              let platformIcon;
              const plat = p.platform || '{{ group.pages.first.platform|default:"facebook" }}';
              if (plat === 'tiktok') {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/tiktoklogo.webp" style="width: 12px; height: 12px;" />`;
              } else if (plat === 'instagram') {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/iglogo.png" style="width: 12px; height: 12px;" />`;
              } else if (plat === 'lemon8') {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/lemon8logo.png" style="width: 12px; height: 12px;" />`;
              } else if (plat === 'youtube') {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/youtubelogo.png" style="width: 12px; height: 12px;" />`;
              } else {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/facebooklogo.png" style="width: 12px; height: 12px;" />`;
              }

              // เนื้อหา Engagement ตามแพลตฟอร์ม
              let engagementHtml = '';
              if (plat === 'tiktok') {
                engagementHtml = `
                  <span>❤️ ${p.like_count || 0}</span>
                  <span>💬 ${p.comment_count || 0}</span>
                  <span>↪ ${p.share_count || 0}</span>
                  <span>🔖 ${p.save_count || 0}</span>
                  <span class="ms-auto fw-semibold text-dark">👁 ${p.view_count || 0}</span>
                `;
              } else {
                const reactions = Object.entries(p.reactions || {}).map(([r, c]) => {
                  const emoji = { 'ถูกใจ':'👍', 'รักเลย':'❤️', 'เศร้า':'😢', 'โกรธ':'😡', 'ว้าว':'😮', 'ฮ่าๆ':'😂', 'ห่วงใย':'🥰' }[r] || '';
                  return `<span>${emoji} ${c}</span>`;
                }).join('');
                engagementHtml = `
                  ${reactions}
                  <span>💬 ${p.comment_count || 0}</span>
                  <span>↪ ${p.share_count || 0}</span>
                  <span class="ms-auto fw-semibold text-dark">🔥 ${p.total_engagement || 0}</span>
                `;
              }

              // URL สำหรับลิงก์ไปที่โพสต์
              let postLink;
              if (plat === 'tiktok') {
                postLink = p.post_url || '#';
              } else {
                postLink = `https://www.facebook.com/${p.post_id}`;
              }

              const imgThumb = (p.post_imgs?.length && p.post_imgs[0]) ? `<a href="${postLink}" target="_blank"><img src="${p.post_imgs[0]}" class="rounded-start" style="height: 100%; width: 90px; object-fit: cover;" /></a>` : `<div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>`;

              return `
                <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
                  <div style="width: 90px; height: 90px; flex-shrink: 0; overflow: hidden;">
                    ${imgThumb}
                  </div>
                  <div class="flex-grow-1 px-2 py-1 d-flex flex-column justify-content-between" style="min-width: 0;">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="d-flex align-items-center gap-2">
                        <img src="${p.profile_pic || defaultProfilePic}" class="rounded-circle" style="width: 16px; height: 16px;">
                        ${platformIcon}
                        <strong class="text-truncate">${p.page_name || ''}</strong>
                      </div>
                      <div class="text-muted small" style="font-size: 0.65rem;">${p.post_timestamp}</div>
                    </div>
                    <div class="mt-1 text-dark" style="display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;font-size: 0.8rem;">
                      ${p.post_content || ''}
                    </div>
                    <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                      ${engagementHtml}
                    </div>
                  </div>
                </div>
              `;
            }).join('');

            document.getElementById('popupContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('popupModal')).show();
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } },
          x: { grid: { display: false } }
        },
        plugins: { legend: { display: false } }
      }
    });
  });
  </script>


  <!-- 🕒 Best Times To Post -->
    <div class="col-md-6 d-flex">
      <div class="card shadow-sm border-0 p-4 w-100">
        <h6 class="mb-3">Best Times To Post</h6>
        <canvas id="bestTimesChart" style="width:100%; height:100%;"></canvas>
      </div>
    </div>
  </div>

  <!-- 📊 Popup Template -->
  <div class="modal fade" id="popupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">Posts in Selected Time Slot</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="popupContent">
          <!-- Content Injected by JS -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    function getColorByPostCount(count) {
      const max = 30;
      const ratio = Math.min(count / max, 1);
      const hue = (1 - ratio) * 240; // 240 = น้ำเงิน → 0 = แดง
      return `hsl(${hue}, 70%, 60%)`;
    }

    const bubbles = JSON.parse('{{ bubble_data|escapejs }}');
    const postMap = JSON.parse('{{ posts_grouped_json|escapejs }}');

    const ctx = document.getElementById("bestTimesChart").getContext("2d");
    const chart = new Chart(ctx, {
      type: 'bubble',
      data: {
        datasets: bubbles.map(b => ({
          data: [{
            x: b.x, y: b.y, r: b.r,
            count: b.count,
            likes: b.likes,
            comments: b.comments,
            shares: b.shares,
            key: b.key,
            label: b.tooltip_label
          }],
          backgroundColor: getColorByPostCount(b.count),
          hoverBackgroundColor: getColorByPostCount(b.count)
        }))
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => [
                ctx.raw.label,
                `${ctx.raw.count} Number of posts`,
                `${ctx.raw.likes} Likes, ${ctx.raw.comments} Comments, ${ctx.raw.shares} Shares`
              ]
            }
          },
          legend: { display: false }
        },
        scales: {
          x: {
            min: -0.5, max: 6.5,
            ticks: { callback: v => ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][v] }
          },
          y: { min: 0, max: 24, ticks: { stepSize: 2 } }
        },
        onClick: (e, elements) => {
          if (elements.length) {
            const key = chart.data.datasets[elements[0].datasetIndex].data[0].key;
            const posts = postMap[key] || [];

            document.querySelector('#popupModal .modal-title').innerText = 'Posts in Selected Time Slot';

            const html = posts.map(p => {
              // Determine platform and set icon
              const plat = p.platform || '{{ group.pages.first.platform|default:"facebook" }}';
              let platformIcon;
              if (plat === 'tiktok') {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/tiktoklogo.webp" style="width: 12px; height: 12px;" />`;
              } else if (plat === 'instagram') {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/iglogo.png" style="width: 12px; height: 12px;" />`;
              } else if (plat === 'lemon8') {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/lemon8logo.png" style="width: 12px; height: 12px;" />`;
              } else if (plat === 'youtube') {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/youtubelogo.png" style="width: 12px; height: 12px;" />`;
              } else {
                platformIcon = `<img src="${window.STATIC_URL}assets/img/icons/facebooklogo.png" style="width: 12px; height: 12px;" />`;
              }

              // Engagement HTML
              let engagementHtml;
              if (plat === 'tiktok') {
                engagementHtml = `
                  <span>❤️ ${p.like_count || 0}</span>
                  <span>💬 ${p.comment_count || 0}</span>
                  <span>↪ ${p.share_count || 0}</span>
                  <span>🔖 ${p.save_count || 0}</span>
                  <span class="ms-auto fw-semibold text-dark">👁 ${p.view_count || 0}</span>
                `;
              } else {
                const reactions = Object.entries(p.reactions || {}).map(([r, c]) => {
                  const emoji = { 'ถูกใจ':'👍', 'รักเลย':'❤️', 'เศร้า':'😢', 'โกรธ':'😡', 'ว้าว':'😮', 'ฮ่าๆ':'😂', 'ห่วงใย':'🥰' }[r] || '';
                  return `<span>${emoji} ${c}</span>`;
                }).join('');
                engagementHtml = `
                  ${reactions}
                  <span>💬 ${p.comment_count || 0}</span>
                  <span>↪ ${p.share_count || 0}</span>
                  <span class="ms-auto fw-semibold text-dark">🔥 ${p.total_engagement || 0}</span>
                `;
              }

              // Thumbnail and link
              let postLink;
              if (plat === 'tiktok') {
                postLink = p.post_url || '#';
              } else {
                postLink = `https://www.facebook.com/${p.post_id}`;
              }
              const thumb = (p.post_imgs?.length && p.post_imgs[0]) ? `<a href="${postLink}" target="_blank"><img src="${p.post_imgs[0]}" style="height: 100%; width: 90px; object-fit: cover;" class="rounded-start" /></a>` : `<div style="height: 100%; width: 90px; background-color: #f8f9fa;"></div>`;

              return `
                <div class="d-flex border rounded mb-2 small overflow-hidden" style="height: 90px;">
                  <div style="width: 90px; height: 90px; flex-shrink: 0; overflow: hidden;">
                    ${thumb}
                  </div>
                  <div class="flex-grow-1 px-2 py-1 d-flex flex-column justify-content-between" style="min-width: 0;">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="d-flex align-items-center gap-2">
                        <img src="${p.profile_pic || defaultProfilePic}" class="rounded-circle" style="width: 16px; height: 16px;">
                        ${platformIcon}
                        <strong class="text-truncate">${p.page_name || ''}</strong>
                      </div>
                      <div class="text-muted small" style="font-size: 0.65rem;">${p.post_timestamp}</div>
                    </div>
                    <div class="mt-1 text-dark" style="display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;font-size: 0.8rem;">
                      ${p.post_content || ''}
                    </div>
                    <div class="d-flex gap-2 text-muted align-items-center" style="font-size: 0.7rem;">
                      ${engagementHtml}
                    </div>
                  </div>
                </div>
              `;
            }).join('');

            document.getElementById('popupContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('popupModal')).show();
          }
        }
      }
    });
  });
  </script>

<br>
<!-- 📌 Top 10 Posts: Engagement Section -->
<div class="card shadow-sm rounded mb-5" style="max-width: 100%; height: 550px; overflow-y: auto; position: relative;">
  <!-- ✅ Sticky Header -->
  <div class="d-flex justify-content-between align-items-center"
       style="position: sticky; top: 0; z-index: 10; background: white; padding: 12px 16px; border-bottom: 1px solid #eee;">
    <h5 class="fw-bold mb-0" style="font-size: 16px;">Top 10 Posts: Engagement</h5>
    <button class="btn btn-light btn-sm border" onclick="openPresentation()">📊 Presentation</button>
  </div>

  <!-- ✅ Grid Layout -->
  <div class="px-3 py-2">
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-xl-6 g-3">
      {% for post in facebook_posts_top10 %}
      <div class="col">
        <a href="https://www.facebook.com/{{ post.post_id }}" target="_blank" class="text-decoration-none">
          <div class="position-relative rounded overflow-hidden shadow-sm" style="height: 250px;">
            <!-- 🔺 Background Image -->
            <img src="{{ post.post_imgs.0 }}" class="w-100 h-100" style="object-fit: cover;">

            <!-- 🔵 Profile Picture + Facebook Icon -->
            <div class="position-absolute top-0 start-0 m-1">
              <div class="position-relative" style="width: 24px; height: 24px;">
                {% if post.page_profile_pic %}
                <img src="{{ post.page_profile_pic }}" class="rounded-circle border border-white"
                     width="24" height="24" style="object-fit: cover;">
                {% else %}
                <img src="{% static 'assets/img/icons/default_profile.png' %}" class="rounded-circle border border-white"
                     width="24" height="24" style="object-fit: cover;">
                {% endif %}
                <img src="{% static 'assets/img/icons/facebooklogo.png' %}"
                     width="10" height="10"
                     class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
              </div>
            </div>

            <!-- 📈 Engagement Rate -->
            <div class="position-absolute top-0 end-0 m-1">
              <span class="bg-dark text-white small px-1 py-0 rounded" style="opacity: 0.85; font-size: 11px;">
                {{ post.engagement_rate }}%
              </span>
            </div>

            <!-- 🕒 Timestamp & Content -->
            <div class="position-absolute bottom-0 start-0 text-white text-shadow px-2 py-1"
                 style="font-size: 10px; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.6));">
              <div class="small mt-1">
                <span class="badge bg-light text-dark" style="font-size: 9px; opacity: 0.85;">
                  📌 {{ post.content_pillar }}
                   </span>
              </div>

              <div>{{ post.post_timestamp }}</div>
              <div class="fw-semibold text-truncate">{{ post.post_content }}</div>
            </div>

            <!-- 📷 Post Type Icon -->
            <div class="position-absolute bottom-0 end-0 m-1">
              {% if post.post_type == "video" %}
              <i class="fas fa-play-circle text-white" style="font-size: 12px;"></i>
              {% else %}
              <i class="fas fa-image text-white" style="font-size: 12px;"></i>
              {% endif %}
            </div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
</div>


<!-- 📊 Presentation Modal -->
<div id="presentationModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">

      <div class="modal-body p-4 d-flex justify-content-center align-items-center" style="height: 100vh;">
          <!-- 🟦 Left Title Section -->
  <div class="pe-5" style="min-width: 300px;">
    <h2 class="fw-bold mb-0" style="font-size: 26px;">Top 10 Posts: Engagement</h2>
  </div>

  <!-- 🟨 Right Cards Section -->
  <div class="flex-grow-1" style="max-width: 1100px;">
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-xl-5 g-3">
      {% for post in facebook_posts_top10 %}
      <div class="col">
        <a href="https://www.facebook.com/{{ post.post_id }}" target="_blank" class="text-decoration-none">
          <div class="position-relative rounded overflow-hidden shadow-sm" style="width: 100%; aspect-ratio: 4/5;">
            <!-- 🔺 Background Image -->
            <img src="{{ post.post_imgs.0 }}" class="w-100 h-100" style="object-fit: cover;">

            <!-- 🔵 Profile Picture + Facebook Icon -->
            <div class="position-absolute top-0 start-0 m-2">
              <div class="position-relative" style="width: 24px; height: 24px;">
                {% if post.page_profile_pic %}
                  <img src="{{ post.page_profile_pic }}" class="rounded-circle border border-white w-100 h-100" style="object-fit: cover;">
                {% else %}
                  <img src="{% static 'assets/img/icons/default_profile.png' %}" class="rounded-circle border border-white w-100 h-100" style="object-fit: cover;">
                {% endif %}
                <img src="{% static 'assets/img/icons/facebooklogo.png' %}" width="10" height="10" class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
              </div>
            </div>

            <!-- 📈 Engagement Rate -->
            <div class="position-absolute top-0 end-0 m-2">
              <span class="bg-dark text-white small px-2 py-1 rounded" style="opacity: 0.85;">{{ post.engagement_rate }}%</span>
            </div>

            <!-- 🕒 Timestamp & Content -->
            <div class="position-absolute bottom-0 start-0 text-white text-shadow p-2" style="font-size: 11px; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.55));">
              <div class="mt-1">
                <span class="badge bg-light text-dark" style="font-size: 10px; opacity: 0.85;">
                  📌 {{ post.content_pillar }}
                </span>
              </div>


              <div>{{ post.post_timestamp }}</div>
              <div class="fw-semibold text-truncate">{{ post.post_content }}</div>
            </div>

            <!-- 📷 Post Type -->
            <div class="position-absolute bottom-0 end-0 m-2">
              {% if post.post_type == "video" %}
                <i class="fas fa-play-circle text-white"></i>
              {% else %}
                <i class="fas fa-image text-white"></i>
              {% endif %}
            </div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

    </div>
  </div>
</div>

<script>
function openPresentation() {
  var modal = new bootstrap.Modal(document.getElementById('presentationModal'));
  modal.show();
}
</script>

  <br>

{% if pillar_summary %}
<!-- 📚 Content Pillar Summary Table -->
<div class="card shadow-sm rounded p-4 mb-4 w-100" style="max-width: 700px; margin: auto;">
  <div class="card-body p-2">
    <h6 class="fw-semibold mb-3" style="font-size: 18px;">Content Pillar Summary</h6>
    <table class="table table-hover small mb-0">
      <thead class="table-light">
        <tr>
          <th style="width: 70%;">Content Pillar</th>
          <th class="text-end">จำนวนโพสต์</th>
        </tr>
      </thead>
      <tbody>
        {% for row in pillar_summary %}
          <tr style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#pillarModal-{{ row.content_pillar|slugify }}">
            <td>
              {% if row.content_pillar == "Realtime" %}🕒{% elif row.content_pillar == "Recipe" %}📋{% elif row.content_pillar == "Promotion" %}💸
              {% elif row.content_pillar == "Product" %}📦{% elif row.content_pillar == "Activity" %}🎯{% elif row.content_pillar == "CSR" %}🌱
              {% elif row.content_pillar == "PR and Event" %}📢{% elif row.content_pillar == "Knowledge" %}📘{% elif row.content_pillar == "Lifestyle" %}🌟
              {% else %}📁{% endif %}
              {{ row.content_pillar }}
            </td>
            <td class="text-end fw-bold">{{ row.post_count }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- 🪟 MODALS -->
{% for row in pillar_summary %}
<div id="pillarModal-{{ row.content_pillar|slugify }}" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-body p-4 d-flex justify-content-center align-items-center" style="height: 100vh; overflow: hidden;">
        <!-- Left Title -->
        <div class="pe-5" style="min-width: 300px;">
          <h2 class="fw-bold mb-1" style="font-size: 22px;">โพสต์ในหมวด</h2>
          <h2 class="fw-semibold text-muted" style="font-size: 26px;">
            {% if row.content_pillar == "Realtime" %}🕒{% elif row.content_pillar == "Recipe" %}📋{% elif row.content_pillar == "Promotion" %}💸
            {% elif row.content_pillar == "Product" %}📦{% elif row.content_pillar == "Activity" %}🎯{% elif row.content_pillar == "CSR" %}🌱
            {% elif row.content_pillar == "PR and Event" %}📢{% elif row.content_pillar == "Knowledge" %}📘{% elif row.content_pillar == "Lifestyle" %}🌟
            {% else %}📁{% endif %}
            "{{ row.content_pillar }}"
          </h2>
        </div>

        <!-- Right Posts -->
        <div class="flex-grow-1" style="max-height: 90vh; overflow-y: auto; overflow-x: hidden;">
          <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-xl-5 g-3">
            {% with found_posts=posts_by_pillar|dictsort:"pillar" %}
              {% for item in found_posts %}
                {% if item.pillar == row.content_pillar %}
                <div class="col">
                  <a href="https://www.facebook.com/{{ item.post.post_id }}" target="_blank" class="text-decoration-none">
                    <div class="position-relative rounded overflow-hidden shadow-sm" style="width: 100%; aspect-ratio: 4/5;">
                      <img src="{{ item.post.post_imgs.0 }}" class="w-100 h-100" style="object-fit: cover;">
                      <div class="position-absolute top-0 start-0 m-2">
                        <div class="position-relative" style="width: 24px; height: 24px;">
                          {% if item.post.page.profile_pic %}
                            <img src="{{ item.post.page.profile_pic }}" class="rounded-circle border border-white w-100 h-100" style="object-fit: cover;">
                          {% else %}
                            <img src="{% static 'assets/img/icons/default_profile.png' %}" class="rounded-circle border border-white w-100 h-100" style="object-fit: cover;">
                          {% endif %}
                          <img src="{% static 'assets/img/icons/facebooklogo.png' %}" width="10" height="10" class="position-absolute bottom-0 end-0 bg-white rounded-circle border border-white">
                        </div>
                      </div>
                      <div class="position-absolute bottom-0 start-0 text-white text-shadow p-2" style="font-size: 11px; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.55));">
                        <div class="mt-1">
                          <span class="badge bg-light text-dark" style="font-size: 10px; opacity: 0.85;">
                            📌 {{ item.pillar }}
                          </span>
                        </div>
                        <div>{{ item.post.post_timestamp_dt|date:"Y-m-d H:i" }}</div>
                        <div class="fw-semibold text-truncate">{{ item.post.post_content }}</div>
                      </div>
                      <div class="position-absolute bottom-0 end-0 m-2">
                        <i class="fas fa-image text-white"></i>
                      </div>
                    </div>
                  </a>
                </div>
                {% endif %}
              {% endfor %}
              {% if not found_posts|length %}
              <div class="text-muted ms-3">ยังไม่มีโพสต์ในหมวดนี้</div>
              {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>
    </div>
{% endfor %}

{% else %}
<!-- ✅ Empty State ถ้าไม่มีเพจเลย -->
<div class="card shadow-sm rounded p-4 mb-4 w-100 text-center" style="max-width: 700px; margin: auto;">
  <div class="text-muted">Page not found, Add Page to see more Dashboard</div>
</div>
{% endif %}
          <br>
{% endblock %}
